<head>
    <meta charset="utf-8"/>
    <title>Search</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css', v=6) }}">
</head>
<body>
<div class="card">
    <h2>Search for any item!</h2>

    <!-- Search-only form (no site checkboxes here) -->
    <form method="get" action="/" style="display:flex; gap:12px; width:100%; margin-bottom:12px;">
        <input type="text" name="q" placeholder="" value="{{ query or '' }}"
               style="flex:1; padding:10px; border:1px solid #dcdfe4; border-radius:10px;">
        <button type="submit">Search</button>
    </form>

    {% if results is defined %}
    <!-- Filters appear only AFTER the first search -->
    <form method="get" action="/" style="display:flex; flex-direction:column; gap:12px;">

        <!-- keep the current query and mark that user touched site filters -->
        <input type="hidden" name="q" value="{{ query }}">
        <input type="hidden" name="site_sel" value="1">

        <!-- Website selection checkboxes -->
        <div style="display:flex; flex-wrap:wrap; gap:8px; width:100%;">
            {% set all_sites = ['amazon', 'hepsiburada', 'n11', 'trendyol'] %}
            {% set selected = selected_sites if selected_sites is defined else all_sites %}
            {% for site in all_sites %}
            <label style="padding:6px 12px; border:1px solid #dcdfe4; border-radius:8px;
                          cursor:pointer; background:#f9f9f9;">
                <input type="checkbox" name="site" value="{{ site }}"
                       {% if site in selected %}checked{% endif %}
                       style="margin-right:6px;">
                {{ site.capitalize() }}
            </label>
            {% endfor %}
        </div>

        <!-- Ban keywords + buttons -->
        <div style="display:flex; gap:8px; align-items:center;">
            <input type="text" name="ban" placeholder="Ban keywords (e.g., case pen protector)"
                   value="{{ ban or '' }}"
                   style="flex:1; padding:10px; border:1px solid #dcdfe4; border-radius:10px;">
            <button type="submit">Apply Filters</button>
            <a href="/?q={{ query | urlencode }}" style="color:#666; text-decoration:none;">Clear Filters</a>
        </div>

        {% if ban %}
        <div style="margin-top:0; color:#666;">Active bans:
            {% for w in ban.split() %}
            <span style="display:inline-block; padding:4px 8px; border:1px solid #e5e7eb; border-radius:999px; margin-right:6px;">
                {{ w }}
            </span>
            {% endfor %}
        </div>
        {% endif %}
    </form>

    <div style="margin-top:16px;">
        {% if results %}
        <div style="margin-bottom:8px; color:#666;">
            Showing {{ results|length }} result{{ '' if results|length == 1 else 's' }} for:
            <strong>{{ query }}</strong>{% if ban %} &nbsp;after filters{% endif %}
        </div>
        <table style="width:100%; border-collapse: collapse;">
            <thead>
            <tr>
                <th style="text-align:left; padding:8px; border-bottom:1px solid #eee;">#</th>
                <th style="text-align:left; padding:8px; border-bottom:1px solid #eee;">Name</th>
                <th style="text-align:left; padding:8px; border-bottom:1px solid #eee;">Price</th>
                <th style="text-align:left; padding:8px; border-bottom:1px solid #eee;">Website</th>
                <th style="text-align:left; padding:8px; border-bottom:1px solid #eee;">URL</th>
            </tr>
            </thead>
            <tbody>
            {% for p in results %}
            <tr>
                <td style="padding:8px; border-bottom:1px solid #f3f3f3;">{{ loop.index }}</td>
                <td style="padding:8px; border-bottom:1px solid #f3f3f3;">{{ p.name }}</td>
                <td style="padding:8px; border-bottom:1px solid #f3f3f3; white-space:nowrap;">{{ p.price_text }}</td>
                <td style="padding:8px; border-bottom:1px solid #f3f3f3;">{{ p.website }}</td>
                <td style="padding:8px; border-bottom:1px solid #f3f3f3;">
                    <a href="{{ p.url }}" target="_blank" rel="noopener">Open</a>
                </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div style="margin-top:8px; color:#a00;">No items found.</div>
        {% endif %}
    </div>

    <!-- Floating Export Button -->
    <div style="position:fixed; bottom:20px; right:20px;">
        <a
                href="/export?q={{ query|urlencode }}&ban={{ (ban or '')|urlencode }}&site_sel=1{% for s in selected_sites %}&site={{ s }}{% endfor %}"
                style="display:inline-block; background:#f0f7ff; border:1px solid #dcdfe4; border-radius:10px; padding:12px 16px; box-shadow:0 2px 6px rgba(0,0,0,.2); text-decoration:none;"
        >
            Export CSV
        </a>
    </div>

    {% endif %}
</div>
</body>


